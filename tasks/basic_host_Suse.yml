# TODO: add update repo for non-oss?
# TODO: fix zypper.conf recommends

# note: deletion of old certificates is currently not supported
- name: install additional CA certificates
  tags:
    - access_setup
  copy:
    src: "{{item}}"
    dest: "/etc/pki/trust/anchors/"
  with_items: "{{ca_certificates|default({})}}"

# this would be better tied to actually changing CA files, but handlers
# only run at the end, which would be too late here. Given that it returns
# very quickly it's not worth the effort to check for changes.
- name: refresh CA trust
  shell: /usr/sbin/update-ca-certificates
  tags:
    - access_setup

- name: use os_release as suse release
  set_fact:
    suse_release: "{{os_release|float}}"
  when: suse_release is undefined and os_release is defined

- name: set suse release
  set_fact:
    suse_release: tumbleweed
    dist_base: http://download.opensuse.org/
    obs_base: http://download.opensuse.org/repositories/
    suse_long_release: openSUSE_Tumbleweed
  when: suse_release is undefined or suse_release == "tumbleweed"
  tags:
    - access_setup

# ansible silently converts "42.2" to float, so string match doesn't work here
- name: handle leap release naming ({{suse_release}})
  set_fact:
    suse_long_release: openSUSE_Leap_{{ suse_release }}
    dist_base: http://download.opensuse.org/distribution/leap/
    obs_base: http://download.opensuse.org/repositories/
    update_url: http://download.opensuse.org/update/leap/{{ suse_release }}
  when: suse_release|float >= 15 and suse_release|float <= 43
  tags:
    - access_setup

- name: set suse longrelease ({{suse_release}})
  set_fact:
    suse_long_release: openSUSE_{{ suse_release }}
    dist_base: http://download.opensuse.org/distribution/
    obs_base: http://download.opensuse.org/repositories/
  when: suse_release is defined and suse_long_release is undefined
  tags:
    - access_setup

- name: set base URL
  set_fact:
    dist_base=http://download.opensuse.org/distribution/
  when: suse_release != "tumbleweed" and dist_base is undefined
  tags:
    - access_setup

- name: set basic packages
  set_fact:
    bare_metal_packages:
      - bridge-utils
      - vlan
      - lvm2
      - ntp
      - dmidecode
      - ipmitool
      - nmap
      - tcpdump
    base_packages:
      - curl
      - libopenssl1_0_0-hmac
      - iproute2
      - net-tools
      - iotop
      - python-xml
      - vim
      - screen
      - strace
      - wget
      - timezone
      - ca-certificates-mozilla
      - ca-certificates
  when: base_packages is undefined
  tags:
    - access_setup

- name: expand package list for bare metal servers
  set_fact:
    base_packages: "{{ base_packages + bare_metal_packages }}"
  when: ansible_virtualization_role == "host"
  tags:
    - access_setup

- name: append extra packages
  set_fact:
    base_packages: "{{ base_packages + suse_extra_packages }}"
  when: suse_extra_packages is defined
  tags:
    - access_setup

- name: configure system proxy
  template:
    src: proxy.j2
    dest: /etc/sysconfig/proxy
    owner: root
    mode: 0755
  when: proxy_host is defined and skip_proxy is undefined
  tags:
    - access_setup

- name: install zypper config
  copy:
    src: "{{ item }}"
    dest: /etc/zypp/{{ item }}
    owner: root
    group: root
    mode: 0644
  with_items:
    - zypp.conf
    - zypper.conf
  tags:
    - access_setup

- name: set core repos
  set_fact:
    core_repos:
      - name: repo-oss
        url: "{{ dist_base }}/{{ suse_release }}/repo/oss"
      - name: repo-non-oss
        url: "{{ dist_base }}/{{ suse_release }}/repo/non-oss"
  tags:
    - access_setup

- name: set additional OBS repos
  zypper_repository:
    name: "{{ item }}"
    repo: "{{ obs_base }}/{{ item }}/{{ suse_long_release }}"
    state: present
    auto_import_keys: yes
    overwrite_multiple: yes
  with_items: "{{obs_repos|default({})}}"
  tags:
    - access_setup

- name: configure core repos
  zypper_repository:
    name: "{{ item.name }}"
    repo: "{{ item.url }}"
    state: present
    auto_import_keys: yes
    overwrite_multiple: yes
  with_items: "{{core_repos}}"
  tags:
    - access_setup

- name: configure update repo
  zypper_repository:
    name: "update-{{ item }}"
    repo: "{{ update_url }}/{{ item }}"
    state: present
    auto_import_keys: yes
    overwrite_multiple: yes
  with_items:
    - oss
    - non-oss
  when: update_url is defined
  tags:
    - access_setup

# this should be merged in ansible 2.4, for now we need to carry a
# newer zypper.py
- name: Upgrade the system
  zypper:
    name: '*'
    state: dist-upgrade
  when: skip_updates is undefined or force_updates is defined

- name: Install base packages
  zypper:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items: "{{base_packages}}"

- name: mask Wicked servicessss
  file:
    src: /dev/null
    dest: /etc/systemd/system/{{item}}.service
    state: link
    force: yes
  when: network_manager is defined and network_manager != "wicked"
  with_items:
    - wicked
    - wickedd-auto4
    - wickedd-dhcp4
    - wickedd-dhcp6
    - wickedd-nanny
    - wickedd
  tags:
    - access_setup